generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * Note:
 * Prisma does not have first-class PostGIS types. We'll store location as
 * a `geometry(Point,4326)` column using a raw migration. The Prisma model uses
 * a `String` field and we perform raw SQL when needed. For simplicity the
 * starter includes a migration example (not autogenerated here).
 */

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  role         String        @default("user")
  createdAt    DateTime      @default(now())
  auth         Auth?
  orders       Order[]
  kitchens     Kitchen[]     @relation("KitchenOwner")
  trialUsage   TrialUsage[]
  subscriptions Subscription[]
  images       Image[]
}

model Auth {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  password       String
  resetOtp       String?
  resetOtpExpiry DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Kitchen {
  id          String     @id @default(cuid())
  ownerId     String
  owner       User       @relation("KitchenOwner", fields: [ownerId], references: [id])
  title       String
  description String?
  location    String?
  images      String[]   @default([])
  coverImage  String?
  createdAt   DateTime   @default(now())
  mealPlans   MealPlan[]
  orders      Order[]
}

model MealPlan {
  id            String         @id @default(cuid())
  kitchenId     String
  kitchen       Kitchen        @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  price         Float
  billingCycle  String         @default("one-off")
  planType      String         @default("subscription")
  availableDays String[]       @default([])
  startTime     String?
  endTime       String?
  items         String         @default("[]")
  menuItems     Json?
  trialEnabled  Boolean        @default(false)
  trialLimit    Int?
  trialPrice    Float?
  trialValidity String?
  trialNewCustomersOnly Boolean @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  schedules     MealPlanSchedule[]
  orders        Order[]
  trialUsage    TrialUsage[]
  subscriptions Subscription[]
}

model Order {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  kitchenId     String
  kitchen       Kitchen   @relation(fields: [kitchenId], references: [id])
  planId        String
  mealPlan      MealPlan? @relation(fields: [planId], references: [id])
  mealType      String?
  isTrial       Boolean   @default(false)
  status        String    @default("created")
  amount        Float
  scheduledDate DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model MealPlanSchedule {
  id            String   @id @default(cuid())
  mealPlanId    String
  mealPlan      MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  dayOfWeek     Int
  mealType      String
  isAvailable   Boolean  @default(true)
  price         Float?
  startTime     String?
  endTime       String?
  orderDeadline String
  deliveryStart String?
  deliveryEnd   String?
  maxOrders     Int?
  menuItems     Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([mealPlanId, dayOfWeek, mealType])
  @@index([mealPlanId])
}

model TrialUsage {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlanId  String
  mealPlan    MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  orderCount  Int      @default(0)
  firstUsedAt DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  @@unique([userId, mealPlanId])
  @@index([userId])
  @@index([mealPlanId])
}

model Subscription {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlanId  String
  mealPlan    MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  mealType    String   // breakfast, lunch, or dinner
  dayOfWeek   Int?     // Optional: specific day of week (0-6), null means all days
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, mealPlanId, mealType, dayOfWeek])
  @@index([userId])
  @@index([mealPlanId])
}

model Image {
  id        String   @id @default(cuid())
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  url       String
  filename  String
  mimeType  String
  size      Int      // Size in bytes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([createdAt])
}
